<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <meta name="description" content="Oficiální stránky PHP komunity">
        <meta name="keywords" content="PHP, komunita, programování">
        <meta name="author" content="http://pehapkari.cz">
        <meta name="robots" content="index, follow">

        <meta property="og:image" content="/images/php-square.png">
    <meta property="og:type" content="article">
    <meta property="og:title" content="How to use Dynamic Constraints with Symfony/Validator">
    <meta property="og:description" content="Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints.">
    <meta property="og:url" content="https://pehapkari.cz/blog/2017/02/24/symfony-validator-dynamic-constraints/">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How to use Dynamic Constraints with Symfony/Validator">
    <meta name="twitter:description" content="Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints.">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

        <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

        <link href="/assets/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css">

    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css">
        <link href="/assets/css/style.css" rel="stylesheet" type="text/css">

        <link href="/favicon.ico" rel="shortcut icon">

        <title>How to use Dynamic Constraints with Symfony/Validator</title>
    </head>

    <body>
<header>
    <div class="container">
        <div class="hidden-xs">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="top-navigation">
                <a href="/blog/" class="active">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/mentori/">
                    <em class="fa fa-handshake-o fa-fw"></em>
                    Mentoři
                </a>
                <a href="/slovnicek/">
                    <em class="fa fa-language fa-fw"></em>
                    Slovníček
                </a>
                <a href="/knihovnicka/">
                    <em class="fa fa-book fa-fw"></em>
                    Knížky
                </a>

                    

                    <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-02-24-symfony-validator-dynamic-constraints.md" class="hidden-sm">
                        <em class="fa fa-fw fa-pencil"></em>
                        Edit
                    </a>
            </nav>
        </div>

        <div id="mobile-menu" class="row text-center hidden-md hidden-sm hidden-lg">
            <a href="/" class="col-xs-3">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-xs-3 active">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/mentori/" class="col-xs-3">
                <em class="fa fa-handshake-o fa-fw"></em>
                <br>
                Mentoři
            </a>
            <a href="/knihovnicka/" class="col-xs-3">
                <em class="fa fa-language fa-fw"></em>
                <br>
                Knížky
            </a>
        </div>
    </div>
</header>

    <div id="article">
        <div class="container">
            <h1 class="h2 text-center">How to use Dynamic Constraints with Symfony/Validator</h1>

            <div class="row text-center">
                <div class="col-md-12">
<div class="metadataLine">
        
        <p class="success">
            <strong><em class="fa fa-fw fa-check-square-o"></em>
                <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/tests/Posts/Year2017/SymfonyValidatorDynamicConstraints">
                    Covered by test
                </a>
            </strong>
        </p>

    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        3 min

        |

        by
        <strong>Jáchym Toušek</strong>

        &ndash;

        <time datetime="2017-02-Fri">
            24. 2. 2017
        </time>

        |

        <em class="fa fa-fw fa-comments"></em>
        <a href="https://pehapkari.cz/blog/2017/02/24/symfony-validator-dynamic-constraints/#disqus_thread">X</a>
        comments
    </p>
</div>
                </div>
            </div>

            <br>

            <div id="article-content">
                <p class="perex">Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints.</p>

                

<h3 id="example-use-case"><a class="anchor" href="#example-use-case" aria-hidden="true"><span class="anchor-icon">#</span></a>Example Use Case</h3>
<p>You have an Address entity with a country and a zipcode. There is a <a href="https://github.com/Soullivaneuh/IsoCodesValidator/blob/master/src/Constraints/ZipCode.php">ZipCodeConstraint constraint</a> available but requires you to specify the country in the options. But you cannot do that in an annotation because the country is present in another field of the Address entity.</p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraints as Assert;

class Address
{
    // street, city, etc.

    /**
     * @var string
     * @Assert\NotBlank()
     * @Assert\Country()
     */
    protected $country;

    /**
     * @todo Validate this field based on the country specified in $this-&gt;country.
     * @var string
     * @Assert\NotBlank()
     * @ZipCodeConstraint(country = "???")
     */
    protected $zipcode;

    // getters and setters
}</code></pre>
<h3 id="creating-the-constraint-dynamically"><a class="anchor" href="#creating-the-constraint-dynamically" aria-hidden="true"><span class="anchor-icon">#</span></a>Creating the constraint dynamically</h3>
<p>Well, it's of course impossible to simply fix the code above by replacing the question marks with something. So we need another approach. <strong>The way to go in this case is the Callback constraint.</strong></p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraints as Assert;
use Symfony\Component\Validator\Context\ExecutionContextInterface;

class Address
{
    // same as above

    /**
     * @Assert\Callback()
     */
    public function validateZipcode(ExecutionContextInterface $context)
    {
        $constraint = new ZipCodeConstraint(['country' =&gt; $this-&gt;country]);
        $violations = $context-&gt;getValidator()-&gt;validate($this-&gt;zipcode, $constraint);

        foreach ($violations as $violation) {
            $context-&gt;getViolations()-&gt;add($violation);
        }
    }
}</code></pre>
<h3 id="correct-violation-context"><a class="anchor" href="#correct-violation-context" aria-hidden="true"><span class="anchor-icon">#</span></a>Correct violation context</h3>
<p>Now this is almost correct except for one flaw. If the zipcode is not valid, the violation is not attached to the zipcode field but to the Address class instead. <strong>Fortunately there is a way to solve this problem as well using ContextualValidator.</strong></p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraints as Assert;
use Symfony\Component\Validator\Context\ExecutionContextInterface;

class Address
{
    // same as above

    /**
     * @Assert\Callback()
     */
    public function validateZipcode(ExecutionContextInterface $context)
    {
        $constraint = new ZipCodeConstraint(['country' =&gt; $this-&gt;country]);
        $context
            -&gt;getValidator()
            -&gt;inContext($context)
            -&gt;atPath('zipcode')
            -&gt;validate($this-&gt;zipcode, $constraint);
    }
}</code></pre>
<p>And that's it! <strong>The violation will be added to the field directly in the intended context</strong> so there is no need to duplicate it.</p>
<p>This approach should solve most of the advanced use-cases you might have. Along with the tips from my previous articles it makes Symfony/Validator a really powerful validation tool.</p>
<h3 id="usage-with-nette-framework"><a class="anchor" href="#usage-with-nette-framework" aria-hidden="true"><span class="anchor-icon">#</span></a>Usage with Nette Framework</h3>
<p>If you want to use the Symfony/Validator component in your Nette application, you will need <a href="https://github.com/Kdyby/Validator">Kdyby/Validator</a>.</p>
            </div>
        </div>

        <div class="intermezzo-smaller">
            <div class="container">
                <h2>What do you think about this?</h2>
            </div>
        </div>

        <div class="container">
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_config = function () {
        this.language = "en"
    };

    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + "pehapkari" + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

    <script src="/assets/prism/prism.js"></script>
    <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', "UA-89860072-1", 'auto');
    ga('send','pageview');
</script>
<script async defer src="https://www.google-analytics.com/analytics.js"></script>
<script>
    !function(f,b,e,v,n,t,s){ if(f.fbq)return;n=f.fbq=function(){ n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', "201338863559186");
    fbq('track', 'PageView');
</script>
    </body>
</html>
